use std::collections::{HashMap, HashSet};

static INPUT: &str = "--- scanner 0 ---\n385,-361,405\n-852,515,-489\n336,928,466\n-790,-808,-512\n-548,-779,374\n-706,-757,-430\n-635,-615,362\n-630,-729,-519\n-963,477,-487\n753,808,-605\n740,774,-615\n352,-454,-949\n-773,645,541\n405,-470,568\n-65,111,-185\n325,-343,553\n413,943,530\n309,881,591\n412,-468,-827\n-189,61,-45\n-818,745,486\n-750,754,404\n726,706,-708\n440,-583,-974\n-805,510,-451\n-627,-769,479\n\n--- scanner 1 ---\n489,-508,-309\n568,401,-321\n-487,530,543\n-550,798,-610\n497,-391,-463\n-544,497,719\n-783,-550,393\n652,483,-270\n-457,473,658\n-490,920,-624\n-810,-592,562\n615,392,827\n-463,-582,-735\n536,-627,507\n-578,945,-495\n-543,-597,-608\n492,490,-349\n-789,-476,539\n25,136,126\n410,-403,-299\n606,508,668\n685,-670,552\n586,-672,641\n-523,-434,-717\n499,373,679\n-71,3,20\n\n--- scanner 2 ---\n276,399,-624\n-840,712,-852\n800,526,509\n360,500,-664\n-742,-523,770\n558,-845,613\n-649,-591,756\n581,-642,-957\n418,-882,493\n757,497,569\n-827,807,-726\n536,-696,-873\n312,551,-727\n-659,795,815\n594,-778,-844\n20,73,-89\n-613,841,682\n-752,-489,783\n-906,-787,-775\n-812,838,-786\n749,714,565\n-868,-782,-822\n-698,801,710\n-106,-13,21\n-870,-820,-933\n401,-902,658\n\n--- scanner 3 ---\n-279,-453,-786\n838,461,-413\n-621,800,-524\n-545,369,642\n815,-636,457\n-646,852,-435\n476,666,563\n-263,-371,-818\n-23,29,-57\n795,-763,-737\n562,-758,-745\n-400,-400,-909\n820,489,-355\n-770,-662,706\n-494,378,536\n-783,-706,788\n414,449,544\n142,-67,-5\n777,511,-512\n-707,790,-599\n727,-826,-761\n-745,-749,708\n864,-418,466\n834,-574,565\n-598,377,432\n465,603,559\n\n--- scanner 4 ---\n-647,440,699\n505,898,-901\n22,-81,-123\n-611,603,609\n-611,-658,458\n563,-536,468\n-937,-323,-520\n510,-416,-846\n-579,848,-814\n449,-429,-811\n604,-566,660\n-493,838,-739\n304,544,210\n362,636,230\n346,634,324\n-921,-405,-552\n503,-402,-934\n-664,-665,488\n-96,70,-18\n-800,-352,-429\n-716,-709,365\n-554,900,-903\n469,-553,647\n542,904,-903\n550,896,-761\n-545,628,698\n\n--- scanner 5 ---\n-414,774,582\n974,-472,-609\n93,174,-27\n955,-324,-725\n657,414,429\n-394,-495,508\n747,436,571\n942,891,-890\n850,-432,434\n874,-493,347\n839,-483,-716\n-495,-349,-942\n851,965,-859\n-392,804,664\n118,-17,-162\n-544,-421,554\n-587,-291,-962\n817,-608,377\n-368,788,712\n-556,-394,529\n-503,558,-474\n-497,-333,-848\n723,963,-893\n-691,660,-473\n-528,624,-563\n566,383,560\n\n--- scanner 6 ---\n798,-555,436\n-604,-897,-416\n619,325,712\n753,406,-711\n101,-17,170\n51,-136,2\n-642,272,-722\n-599,373,-772\n-527,-832,-504\n-532,491,451\n-612,-748,860\n-449,510,549\n-622,273,-805\n694,-724,-541\n-612,-754,931\n-645,-675,822\n558,443,750\n561,470,-749\n-511,475,655\n-543,-951,-543\n794,-653,527\n617,274,770\n610,-630,-456\n619,431,-738\n820,-499,546\n562,-640,-556\n\n--- scanner 7 ---\n479,542,709\n-673,-467,238\n673,720,-704\n-534,704,314\n647,672,-922\n-614,848,-695\n-938,-526,-493\n-86,17,-20\n-393,704,289\n-902,-519,-547\n456,-414,286\n549,-447,-612\n13,91,-150\n431,-325,234\n575,-453,-692\n601,-450,-681\n-461,803,242\n-564,755,-675\n583,646,708\n-859,-564,-497\n-623,608,-719\n532,752,717\n370,-489,296\n587,600,-778\n-628,-327,236\n-665,-325,230\n\n--- scanner 8 ---\n-743,443,-573\n-751,653,-520\n744,501,-465\n878,700,546\n-609,-501,802\n647,-549,-451\n115,-13,88\n658,-552,-477\n-330,-588,-682\n-659,-402,863\n567,-531,513\n-320,-513,-596\n-454,574,501\n670,621,-379\n-742,547,-469\n-631,-344,845\n812,-532,539\n-18,-135,33\n-268,-424,-621\n602,-561,524\n-517,570,490\n724,728,514\n708,707,475\n-671,555,439\n578,-546,-503\n888,573,-405\n\n--- scanner 9 ---\n705,-503,604\n-335,-443,849\n680,-530,616\n652,665,746\n732,-509,-465\n-280,699,-557\n570,695,768\n-327,-606,-518\n-719,425,838\n822,647,-472\n-309,-523,-623\n59,-49,30\n585,-560,-504\n726,-604,766\n-309,-689,-683\n-661,388,843\n-308,-564,802\n742,550,-366\n-339,758,-721\n594,-516,-507\n-251,780,-536\n-679,295,781\n701,570,-560\n522,679,792\n-334,-506,795\n\n--- scanner 10 ---\n-493,-738,481\n626,420,-605\n25,-161,-88\n-343,582,748\n359,747,865\n446,-807,-469\n867,-703,489\n-24,-20,30\n285,716,774\n814,-714,670\n-828,-960,-523\n462,-855,-445\n-360,728,861\n-595,335,-767\n-647,-713,543\n-520,-690,543\n-415,628,729\n-821,-795,-424\n-520,357,-631\n-640,249,-633\n-847,-832,-399\n590,330,-768\n287,750,646\n476,-725,-491\n836,-572,580\n692,331,-580\n\n--- scanner 11 ---\n493,603,-940\n-843,573,457\n-120,-99,-113\n-914,573,451\n440,-656,-798\n-568,747,-793\n419,-631,-841\n433,565,308\n577,489,-919\n-529,-859,706\n560,504,254\n-578,-811,-581\n573,-601,565\n-419,-837,650\n558,-733,481\n-551,-733,-618\n-446,-660,-591\n473,-649,575\n-570,601,-753\n466,516,-944\n-510,-833,552\n-805,606,530\n470,-635,-955\n-644,742,-738\n521,488,373\n\n--- scanner 12 ---\n531,-441,734\n-551,359,-671\n-497,443,-626\n-411,494,778\n-22,154,-76\n537,-661,-363\n-582,-580,400\n588,857,-415\n481,-668,-440\n-757,-603,-823\n-551,-631,512\n48,40,58\n-373,383,780\n833,716,748\n459,-711,-401\n-406,541,816\n-770,-525,-830\n912,556,755\n388,-410,812\n399,-412,604\n-415,472,-684\n346,849,-411\n861,640,837\n-748,-667,-765\n517,837,-425\n-439,-568,520\n\n--- scanner 13 ---\n-361,818,515\n719,504,826\n573,566,-588\n596,429,-697\n-580,-842,-629\n-556,774,553\n798,399,836\n-568,-722,-486\n-447,753,626\n640,-405,814\n383,-462,-420\n494,-464,-458\n528,511,-688\n-441,-508,484\n556,-487,865\n-410,-430,341\n716,-494,786\n-631,-730,-598\n711,387,672\n-412,-638,352\n541,-426,-453\n-637,725,-609\n53,-73,-91\n-712,739,-650\n-515,781,-610\n\n--- scanner 14 ---\n-432,-626,437\n921,-462,-535\n-1,130,-22\n925,-435,-622\n-547,738,358\n-450,-589,388\n-273,-529,-634\n900,-546,-649\n662,633,679\n576,650,722\n-672,796,422\n554,-749,369\n-549,836,-532\n734,601,-537\n-494,-681,281\n-491,889,443\n-476,874,-565\n651,-678,480\n649,768,710\n-470,945,-565\n719,675,-396\n-327,-402,-573\n-392,-490,-650\n663,-675,370\n774,599,-391\n\n--- scanner 15 ---\n-160,0,108\n-418,691,790\n537,-727,-364\n-465,650,-664\n-478,657,848\n373,734,-508\n516,854,-496\n656,810,723\n592,-666,733\n508,821,735\n-534,576,763\n497,-769,-561\n-89,116,-25\n-454,442,-666\n-647,-669,598\n496,-713,-439\n606,-789,881\n-739,-741,-629\n454,817,757\n485,742,-445\n-569,-584,479\n-597,520,-635\n-666,-762,-520\n-628,-806,-715\n-605,-460,611\n513,-733,870\n\n--- scanner 16 ---\n-499,-680,-324\n676,-527,841\n286,640,838\n661,-549,-468\n733,-642,871\n-535,-640,710\n-506,-738,-350\n-87,-100,23\n408,626,778\n766,-522,-541\n-821,857,-492\n261,511,750\n-140,43,158\n-586,738,730\n634,-512,-390\n709,-703,784\n683,775,-342\n-826,854,-557\n-593,616,765\n-685,-714,664\n-452,-801,-351\n-569,632,629\n-910,864,-450\n-697,-741,689\n793,719,-364\n702,621,-368\n\n--- scanner 17 ---\n666,-576,-800\n336,505,-903\n-644,-890,276\n-664,574,-931\n798,-547,-670\n19,-1,-124\n-370,-698,-507\n660,-796,297\n-845,221,630\n285,421,-821\n738,-846,335\n-413,-653,-457\n680,702,359\n-599,-750,278\n809,-545,-878\n-334,-691,-453\n-653,467,-796\n-787,241,538\n-803,335,540\n851,714,345\n364,581,-814\n716,-803,374\n-607,-892,270\n-812,458,-912\n-81,-171,5\n609,722,349\n\n--- scanner 18 ---\n604,810,-643\n74,-73,-108\n748,-417,-719\n-528,-769,-419\n-384,-687,330\n-596,358,-427\n711,846,481\n608,-674,447\n708,-684,495\n-554,585,420\n621,-363,-658\n660,-482,-642\n762,732,477\n623,-590,579\n-529,-877,-373\n-396,611,501\n715,835,-670\n-430,543,503\n-710,-772,-377\n-637,429,-568\n-533,-752,298\n741,689,502\n-491,-604,259\n-663,387,-590\n688,831,-757\n-49,74,-11\n\n--- scanner 19 ---\n-845,545,-570\n638,-861,612\n-470,-704,782\n-754,456,817\n-897,-444,-763\n724,-926,723\n673,530,886\n529,747,-246\n-752,565,-620\n522,693,-282\n-132,-85,77\n675,322,897\n-907,-498,-737\n-795,-424,-671\n39,46,-18\n-839,537,873\n567,743,-325\n580,-684,-321\n-605,521,-561\n518,-751,-274\n-602,-580,746\n-589,-789,704\n529,-882,685\n644,400,754\n583,-602,-342\n-781,571,933\n\n--- scanner 20 ---\n685,561,-454\n729,-658,-594\n-812,-563,560\n-375,718,400\n20,-185,106\n-851,-599,733\n-116,-15,73\n-858,708,-597\n-744,-616,566\n-411,630,470\n-838,-601,-614\n751,-688,520\n579,722,370\n617,-607,-625\n692,595,-656\n-852,-526,-573\n-914,719,-504\n609,-670,-737\n-397,549,384\n696,573,-602\n589,699,440\n794,-790,564\n704,-633,575\n-894,-723,-613\n404,696,388\n-791,571,-518\n\n--- scanner 21 ---\n-855,800,771\n655,848,580\n-620,-565,-666\n-362,515,-925\n-109,-88,-80\n38,64,-142\n694,-445,-719\n-800,-678,370\n-799,-582,-760\n609,867,-679\n-476,605,-883\n659,-458,-780\n751,875,-687\n532,-389,606\n-382,607,-867\n662,771,636\n-812,-595,-625\n-843,786,600\n423,-414,582\n749,869,-724\n-768,-746,302\n-863,796,529\n782,-431,-726\n705,810,658\n-817,-706,349\n528,-431,599\n\n--- scanner 22 ---\n-859,707,534\n-652,-885,854\n-885,649,527\n734,638,-540\n501,555,415\n-122,17,38\n598,-630,-379\n-741,518,-633\n729,-614,500\n565,-557,-341\n685,-515,540\n782,-509,590\n-759,-895,938\n-819,481,-606\n565,-551,-270\n488,500,449\n-717,-888,849\n-845,-750,-765\n-668,491,-738\n593,653,-614\n609,576,394\n-867,-806,-655\n739,693,-616\n-858,770,480\n-841,-652,-674\n\n--- scanner 23 ---\n295,561,-302\n-624,-580,-818\n704,-540,-519\n-713,657,-532\n714,619,674\n-667,-620,-650\n-609,-575,615\n320,561,-443\n459,-616,632\n715,723,570\n-772,665,678\n-698,545,764\n-669,510,-473\n-436,-559,675\n248,462,-370\n-810,-554,-737\n723,513,623\n-531,-664,620\n590,-596,-573\n521,-724,589\n599,-599,-589\n-36,-9,37\n-916,593,738\n549,-739,636\n-689,417,-523\n\n--- scanner 24 ---\n-901,-836,-721\n501,-702,-661\n-147,-65,-100\n-778,-809,-775\n681,-589,375\n-866,453,503\n-813,-822,-714\n15,-149,-23\n419,818,-707\n721,291,770\n759,460,788\n-647,-836,604\n693,-672,-620\n-438,348,-845\n698,-561,354\n649,-521,307\n411,637,-674\n680,-685,-755\n-839,610,403\n657,487,740\n-443,550,-780\n-852,553,420\n536,703,-760\n-448,465,-718\n-542,-853,587\n-651,-878,611\n\n--- scanner 25 ---\n709,-391,-314\n465,673,559\n550,-429,507\n-788,-828,911\n-727,-675,-806\n431,330,-492\n714,-488,448\n-94,-82,102\n-845,-868,781\n22,33,-55\n773,-553,-269\n-710,-711,-660\n-775,421,511\n359,593,656\n-845,396,-782\n529,-400,426\n-753,503,541\n498,413,-373\n-754,-695,-812\n-820,433,-756\n518,259,-426\n-799,373,527\n553,552,636\n-850,-810,818\n-721,268,-763\n671,-463,-280\n\n--- scanner 26 ---\n35,14,-30\n795,712,634\n-496,-457,-634\n-438,-512,622\n911,721,793\n-360,477,-699\n-600,-533,723\n930,605,645\n-472,-593,-650\n820,758,-304\n-541,844,784\n773,-381,509\n-588,-558,696\n-346,465,-870\n830,-351,624\n902,674,-355\n806,-438,685\n358,-472,-529\n-539,938,768\n-350,457,-628\n-489,-492,-756\n-631,958,826\n505,-444,-644\n813,598,-383\n-28,144,95\n383,-384,-658\n\n--- scanner 27 ---\n521,-669,538\n688,752,-381\n-647,-313,847\n762,-675,-450\n818,723,-513\n-36,-76,57\n-356,-876,-753\n528,-635,740\n681,-760,-394\n-317,453,-441\n517,-647,592\n-681,497,766\n484,584,600\n604,596,457\n-613,-439,740\n896,754,-370\n647,-702,-334\n-546,-368,776\n69,68,-61\n-746,639,788\n-356,496,-463\n-414,-735,-742\n-739,561,775\n-377,-781,-809\n-279,503,-519\n596,533,569\n\n--- scanner 28 ---\n720,924,-448\n724,810,-397\n-385,561,-448\n-630,741,525\n-596,-473,973\n496,-737,551\n544,550,600\n75,125,153\n-631,-586,-569\n-624,-588,826\n706,-606,-451\n695,560,468\n-684,-602,948\n622,587,573\n699,767,-418\n-391,415,-522\n754,-596,-551\n-717,680,501\n518,-681,441\n-651,-695,-406\n622,-512,-536\n-711,-713,-554\n-364,584,-564\n-687,565,558\n522,-583,532\n\n--- scanner 29 ---\n-823,470,453\n-709,512,543\n-386,635,-644\n788,630,-624\n-565,729,-627\n647,674,646\n803,-625,648\n851,-609,672\n631,-480,-486\n-424,-445,512\n721,-595,626\n551,-577,-592\n-575,-445,-749\n-334,-481,349\n641,579,-585\n88,46,-17\n668,573,484\n-668,-550,-800\n-373,770,-657\n-335,-379,537\n779,586,-627\n672,-500,-680\n-545,-498,-756\n30,194,-138\n693,600,496\n-803,528,545\n\n--- scanner 30 ---\n-778,664,828\n1,-110,-8\n244,-560,-500\n248,710,-712\n-491,-657,-314\n301,-464,837\n-487,-619,-235\n398,724,536\n340,865,525\n-689,755,-559\n-713,515,-550\n-541,-612,-271\n320,611,-639\n242,-420,-545\n-834,-734,765\n-704,-763,897\n263,-514,759\n-143,-71,135\n361,770,469\n-669,662,-609\n340,-507,815\n236,-418,-508\n295,611,-780\n-663,691,944\n-912,-765,908\n-697,749,884\n\n--- scanner 31 ---\n940,572,696\n-608,-545,562\n-507,-439,579\n68,30,107\n-472,-561,586\n-510,332,533\n-487,-666,-268\n462,-496,450\n659,-840,-812\n-399,-537,-293\n583,-812,-723\n805,432,-753\n450,-325,436\n743,-891,-730\n-800,725,-637\n758,427,-791\n-675,312,516\n442,-567,440\n827,436,709\n-459,-551,-415\n-787,691,-627\n-26,-37,-36\n916,394,-755\n-630,369,673\n-773,623,-534\n856,518,651\n\n--- scanner 32 ---\n455,509,-890\n-779,-433,511\n-465,299,387\n443,677,651\n-590,309,-781\n409,463,-757\n536,-899,-640\n538,690,777\n-562,228,-625\n136,-163,-58\n750,-510,589\n-17,-14,-89\n412,662,711\n-673,-460,592\n724,-950,-584\n-437,-561,-789\n-498,277,-744\n449,548,-785\n-512,356,535\n-462,283,638\n699,-462,652\n753,-907,-644\n-419,-482,-769\n-627,-472,557\n-399,-483,-864\n851,-426,549";

type Vec3 = [i32; 3];

// Rotations painstakingly obtained by doing matrix multiplications in a loop
// and removing the duplicates.
fn rotate([x, y, z]: Vec3, rot: u8) -> Vec3 {
    match rot {
        0 => [z, x, y],
        1 => [z, y, -x],
        2 => [x, y, z],
        3 => [y, -x, z],
        4 => [-y, -x, -z],
        5 => [x, z, -y],
        6 => [z, -x, -y],
        7 => [-x, z, y],
        8 => [-z, x, -y],
        9 => [-x, y, -z],
        10 => [-y, x, z],
        11 => [-x, -y, z],
        12 => [-y, z, -x],
        13 => [x, -z, y],
        14 => [-x, -z, -y],
        15 => [y, x, -z],
        16 => [y, -z, -x],
        17 => [-z, y, x],
        18 => [z, -y, x],
        19 => [-z, -x, y],
        20 => [-z, -y, -x],
        21 => [x, -y, -z],
        22 => [-y, -z, x],
        23 => [y, z, x],
        _ => unreachable!(),
    }
}

fn identify_scanner(
    found_scanners: &mut HashSet<Vec3>,
    found_beacons: &mut HashSet<Vec3>,
    current_beacons: &[Vec3],
) -> bool {
    for rot in 0..24 {
        let mut num_distances = HashMap::new();
        let rotated: Vec<Vec3> = current_beacons
            .iter()
            .map(|&beacon| rotate(beacon, rot))
            .collect();
        for &[x1, y1, z1] in found_beacons.iter() {
            for &[x2, y2, z2] in &rotated {
                let dx = x2 - x1;
                let dy = y2 - y1;
                let dz = z2 - z1;
                let distance = num_distances.entry([dx, dy, dz]).or_insert(0);
                *distance += 1;
                if *distance >= 12 {
                    let rotated: Vec<Vec3> = rotated
                        .iter()
                        .map(|&beacon| [beacon[0] - dx, beacon[1] - dy, beacon[2] - dz])
                        .collect();
                    found_beacons.extend(rotated);
                    found_scanners.insert([dx, dy, dz]);
                    return true;
                }
            }
        }
    }
    false
}

fn main() {
    let mut input: Vec<Vec<Vec3>> = INPUT
        .split("\n\n")
        .map(|scanner| {
            scanner
                .lines()
                .skip(1)
                .map(|beacon| {
                    let mut parts = beacon.split(',').map(|coord| coord.parse().unwrap());
                    [
                        parts.next().unwrap(),
                        parts.next().unwrap(),
                        parts.next().unwrap(),
                    ]
                })
                .collect()
        })
        .collect();

    let mut found_scanners = HashSet::from([[0, 0, 0]]);
    let mut found_beacons = HashSet::new();
    for &beacon in &input[0] {
        found_beacons.insert(beacon);
    }
    input.swap_remove(0);

    while !input.is_empty() {
        input.retain(|beacons| !identify_scanner(&mut found_scanners, &mut found_beacons, beacons));
    }

    println!("Part one: {}", found_beacons.len());

    let mut max_dist = 0;
    for a in &found_scanners {
        for b in &found_scanners {
            if a == b {
                continue;
            }
            let dist = a[0] - b[0] + a[1] - b[1] + a[2] - b[2];
            if dist > max_dist {
                max_dist = dist;
            }
        }
    }

    println!("Part two: {}", max_dist);
}
